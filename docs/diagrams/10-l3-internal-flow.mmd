flowchart TB
    subgraph LookupFlow[L3 Lookup Hit Flow]
        LookupStart([Pingora calls lookup])
        GetManifest[IndexStore.get<br/>Fetch manifest for key]
        CheckExpiry{Manifest<br/>expired?}
        BlobGet[BlobStore.get<br/>Stream object data]
        WrapHit[Wrap reader in BlobHit<br/>Deserialize CacheMeta]
        ReturnHit[Return CacheMeta + HitHandler]
        ReturnMiss[Return None miss]
        
        LookupStart --> GetManifest
        GetManifest --> CheckExpiry
        CheckExpiry -->|Yes or not found| ReturnMiss
        CheckExpiry -->|No, valid TTL| BlobGet
        BlobGet --> WrapHit
        WrapHit --> ReturnHit
    end
    
    subgraph MissFlow[L3 Miss Write Flow]
        MissStart([Pingora calls get_miss_handler])
        CreateWriter[BlobStore.put<br/>Create multipart writer]
        ReturnHandler[Return BlobMiss handler]
        
        WriteLoop[Pingora calls write_body<br/>Stream chunks to BlobWrite]
        BufferParts[Buffer to 5MB parts<br/>Upload parts async]
        
        FinishCall[Pingora calls finish]
        CompleteBlob[BlobWrite.complete<br/>Finalize multipart]
        CreateManifest[Build Manifest<br/>• ObjectId from blob<br/>• Serialize CacheMeta<br/>• Calculate TTL]
        PutManifest[IndexStore.put_new<br/>Atomic first-write-wins]
        CheckCAS{CAS<br/>success?}
        Success[Return Success]
        AlreadyExists[Return Success<br/>degrade to update]
        
        MissStart --> CreateWriter
        CreateWriter --> ReturnHandler
        ReturnHandler --> WriteLoop
        WriteLoop --> BufferParts
        BufferParts --> FinishCall
        FinishCall --> CompleteBlob
        CompleteBlob --> CreateManifest
        CreateManifest --> PutManifest
        PutManifest --> CheckCAS
        CheckCAS -->|Yes| Success
        CheckCAS -->|PreconditionFailed| AlreadyExists
    end
    
    subgraph Dataflow[Data Path]
        direction LR
        CacheKey[CacheKey] -->|hash to| ObjectId[ObjectId<br/>blob key]
        Manifest[Manifest in IndexStore] -->|points to| ObjectId
        Manifest -->|contains| CacheMeta[Serialized CacheMeta]
        ObjectId -->|retrieves| Blob[Blob in BlobStore]
    end
    
    style GetManifest fill:#DDA0DD
    style BlobGet fill:#FFB6C6
    style CreateWriter fill:#FFB6C6
    style PutManifest fill:#DDA0DD
    style Success fill:#90EE90
    style AlreadyExists fill:#90EE90
    style ReturnMiss fill:#FFE4B5
