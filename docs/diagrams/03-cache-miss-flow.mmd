flowchart TD
    Miss([Origin Fetch])
    Meta[Parse CacheMeta<br/>Get Content-Length if present]
    
    subgraph "FanoutMiss: Create Handlers"
        GateL0{size ≤ l0_max?<br/>2MB}
        GateL1{size ≤ l1_max?<br/>64MB}
        GateL2{size ≤ l2_max?<br/>unlimited}
        
        CreateL0[Create L0 MissHandler]
        CreateL1[Create L1 MissHandler]
        CreateL2[Create L2 MissHandler]
        CreateL3[Create L3 MissHandler<br/>always created]
        
        SkipL0[Skip L0]
        SkipL1[Skip L1]
        SkipL2[Skip L2]
    end
    
    subgraph "Stream Phase: write_body"
        StreamChunk[Receive chunk from origin]
        TrackSize[total += chunk.len]
        
        CheckL0H{L0 handler exists<br/>& total ≤ l0_max?}
        WriteL0[Write to L0]
        DropL0[Drop L0 handler<br/>oversize]
        
        CheckL1H{L1 handler exists<br/>& total ≤ l1_max?}
        WriteL1[Write to L1]
        DropL1[Drop L1 handler]
        
        CheckL2H{L2 handler exists<br/>& total ≤ l2_max?}
        WriteL2[Write to L2]
        DropL2[Drop L2 handler]
        
        WriteL3[Write to L3<br/>always written]
        
        MoreChunks{More chunks?}
    end
    
    Finish[finish all surviving handlers]
    Result{All finish<br/>succeeded?}
    Success[MissFinishType::Success]
    Failed[MissFinishType::Failed]
    
    Miss --> Meta
    Meta --> GateL0
    
    GateL0 -->|Yes| CreateL0
    GateL0 -->|No or unknown| SkipL0
    CreateL0 --> GateL1
    SkipL0 --> GateL1
    
    GateL1 -->|Yes| CreateL1
    GateL1 -->|No or unknown| SkipL1
    CreateL1 --> GateL2
    SkipL1 --> GateL2
    
    GateL2 -->|Yes| CreateL2
    GateL2 -->|No| SkipL2
    CreateL2 --> CreateL3
    SkipL2 --> CreateL3
    
    CreateL3 --> StreamChunk
    
    StreamChunk --> TrackSize
    TrackSize --> CheckL0H
    
    CheckL0H -->|Yes| WriteL0
    CheckL0H -->|No| DropL0
    WriteL0 --> CheckL1H
    DropL0 --> CheckL1H
    
    CheckL1H -->|Yes| WriteL1
    CheckL1H -->|No| DropL1
    WriteL1 --> CheckL2H
    DropL1 --> CheckL2H
    
    CheckL2H -->|Yes| WriteL2
    CheckL2H -->|No| DropL2
    WriteL2 --> WriteL3
    DropL2 --> WriteL3
    
    WriteL3 --> MoreChunks
    MoreChunks -->|Yes| StreamChunk
    MoreChunks -->|No| Finish
    
    Finish --> Result
    Result -->|Yes| Success
    Result -->|No| Failed
    
    style CreateL0 fill:#90EE90
    style CreateL1 fill:#87CEEB
    style CreateL2 fill:#DDA0DD
    style CreateL3 fill:#F08080
    style Success fill:#90EE90
    style Failed fill:#FFB6C6
